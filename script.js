document.getElementById("jkhForm").addEventListener("submit", async function (e) {
  e.preventDefault();

  const userInput = document.getElementById("userInput").value.trim();
  const comments = document.getElementById("comments").value.trim();
  const output = document.getElementById("output");
  const loading = document.getElementById("loading");

  output.innerText = "";
  loading.style.display = "block";

  const prompt = `
Роль: Ты — профессиональный специалист по работе с обращениями граждан, эксперт в сфере ЖКХ. У тебя есть опыт составления официальных, вежливых и юридически точных ответов от имени управляющей компании.
________________________________________
Контекст: Ты работаешь в управляющей компании, обслуживающей многоквартирные дома в Петрозаводске. Ты обрабатываешь жалобы и заявки жильцов, отвечаешь им письменно. Ответ должен быть:
– вежливым, уважительным и понятным;
– соответствовать деловому стилю, но без канцеляризмов.
________________________________________
Задача:
Подготовь письменный ответ на обращение жильца, размещённое в разделе Обращение. Если в разделе Моё замечание указано пояснение, обязательно учти его и вежливо раскрой его с объяснением. 
________________________________________
Требования:
  1. Начать с уважительного обращения (например: Уважаемый Иван Иванович!, если ФИО есть, или Уважаемый заявитель!)
  2. Продолжить благодарностью за обращение, указав источник обращения (ГИС ЖКХ, e‑mail, сайт УК и т. д.), если он известен.  
  3. Кратко пересказать суть обращения (1–2 предложения).  
  4. Дать правовое обоснование с точными номерами и статьями.
  5. При необходимости сформулировать рекомендации в виде нумерованного списка.  
  6. При необходимости дать инструкции по дальнейшим действиям заявителя (направить заявление, обратиться в компетентные органы и т. д.).  
  7. Завершить вежливым прощанием и контактными данными.  
  8. Разбить текст на абзацы, избегать канцеляризмов и шаблонных фраз без обоснования. 
9. Ответ должен звучать как человеческое письмо, а не официальная справка. Используй вводные слова ('Поэтому'  Одновременно сообщаем', Рекомендуем'  ) вместо рубрик 
10. В ответе **не должно быть** Markdown-разметки. Используй только обычные цифры для нумерованных списков и пустые строки для абзацев. **Не используй** просто символы новой строки внутри абзаца для имитации абзацев. Реальные абзацы должны быть разделены **пустой строкой**. Ответ должен выглядеть как человеческое письмо
11. **Форматирование ответа:**
*   Обязательно используй **видимые символы абзаца** в ответе. Каждый смысловой блок текста должен быть отделен **пустой строкой** сверху и снизу.
*   **Не используй** просто символы новой строки (обратный слеш n) внутри абзаца для имитации абзацев. Реальные абзацы должны быть разделены **пустой строкой**.
*   **Техническое требование:** В ответе **не должно быть** Markdown-разметки (вроде решеток, двойных звездочек.). Используй только обычные цифры для нумерованных списков и пустые строки для абзацев.

________________________________________
Возможный образец структуры:  
1. Обращение + благодарность.  
2. Суть проблемы: "Вы сообщили о..."  
3. Объяснение: "Согласно ст. Х закона..." → "На практике это означает..."  
4. Действия: "Рекомендуем вам...", "УК со своей стороны..."  
5. Контакты для вопросов.  

________________________________________
Обращение:

${userInput}

Моё замечание:
${comments}
`;

  try {
    const response = await fetch("https://answer2.vercel.app/api/openrouter", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        model: "deepseek/deepseek-r1-0528:free",
        messages: [
          { role: "user", content: prompt }
        ]
      })
    });

    const data = await response.json();
    output.innerText =
      data.choices?.[0]?.message?.content || "⚠️ Ответ не удалось получить.";

  } catch (error) {
    console.error("Ошибка:", error);
    output.innerText = "❌ Ошибка при генерации. Попробуйте позже.";
  } finally {
    loading.style.display = "none";
  }
});
